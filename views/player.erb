<h1>ğŸ® Mastermind - You Guess</h1>

<div class="info-box">
  <strong>Turn <%= @current_turn + 1 %> of <%= @max_turns %></strong>
  <p>Try to guess the secret code of 4 colors.</p>
</div>

<% if session[:error] %>
  <div class="error">
    <%= session[:error] %>
    <% session.delete(:error) %>
  </div>
<% end %>

<% if session[:result] %>
  <div class="result <%= session[:result] %>">
    <%= session[:message] %>
  </div>

  <% if session[:result] == 'lost' %>
    <div class="info-box">
      <strong>The secret code was:</strong> <%= @game_data[:secret_code].join(', ') %>
    </div>
  <% end %>

  <form action="/reset" method="post">
    <button type="submit" class="btn">Play Again</button>
  </form>
<% else %>
  <div class="color-options">
    <strong>Available colors:</strong> red, green, blue, orange, yellow, purple
  </div>

  <form action="/play/player/guess" method="post">
    <h3>Select your guess:</h3>

    <% 4.times do |i| %>
      <select name="guess[]">
        <% %w[red green blue orange yellow purple].each do |color| %>
          <option value="<%= color %>"><%= color.capitalize %></option>
        <% end %>
      </select>
    <% end %>

    <br><br>
    <button type="submit" class="btn">Submit Guess</button>
  </form>

<% end %>

<% if @history && @history.length > 0 %>
  <div class="history">
    <h2>Guess History:</h2>
    <% @history.reverse.each do |entry| %>
      <div class="history-item">
        <%
          # Handle both old (guess array) and new (guess_str string) format
          if entry[:guess_str]
            guess_display = entry[:guess_str].split('|').join(', ')
          elsif entry[:guess]
            guess_display = entry[:guess].is_a?(Array) ? entry[:guess].join(', ') : entry[:guess]
          else
            guess_display = "Unknown"
          end
        %>
        <strong>Turn <%= entry[:turn] %>:</strong> <%= guess_display %>
        <br>
        <span style="color: #28a745;">âœ“ Exact: <%= entry[:exact] %></span> |
        <span style="color: #ffc107;">â— Partial: <%= entry[:partial] %></span>
      </div>
    <% end %>
  </div>
<% end %>

<form action="/reset" method="post" style="margin-top: 30px;">
  <button type="submit" class="btn btn-secondary">Start Over</button>
</form>